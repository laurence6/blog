---
layout: post
title: 工作在 OSC
tags: ["linux", "C++"]
---
<p>
这个暑假开始在 Ohio Supercomputer Center (OSC) 工作了。主要工作是一个基于图片生成地形高度的 C++ 项目。其实我也不太懂是怎么做到的，就是很神奇的算法啦。但神奇算法计算量比较大，所以我们要试图优化运行时间和减少内存占用。另外这个程序里还有一些神秘的 bug，最好也能解决掉它们。
</p>

<h3>2019 年 5 月 20 日</h3>
<p>
上一周基本上在熟悉项目，然后写一些 Python 的测试脚本，并替代一些原来的 bash 脚本，我的老本行啦。这周第一天，我解决了我的第一个 bug。今天早晨，他们和我说，说是我们的超级计算机有超新的编译器啦，GCC 9.1.0。我都惊呆了耶，我用的 Arch Linux，都还没用上 GCC 9.1.0，才只有 8.3.0。然而，我们的程序用 GCC 9.1.0 并开最高优化级别编译之后，就 crash 了。错误信息长这样 <code>Floating point exception(core dumped)</code>。不过好消息是，一个巨大的 core 真的被存下来了 (吐核成功)。然后上 gdb，看一下执行到哪一步了。在一个函数返回之前。这个函数大概长这样:
</p>
{% highlight cpp %}
int Func(int a, int b)
{% endhighlight %}
<p>
但是这个函数没有返回任何值，这就产生了一个 C++ 里的 undefined behavior。然后在运行的时候的表现就是 crash。我还不是很了解为什么会导致一个浮点数相关的 crash，但至少现在一切正常啦。
</p>

<h3>2019 年 5 月 21 日</h3>
<p>
今天全天三个系统都例行维护，所以昨天晚上我就把我今天要用的文件拷贝到我自己电脑上了。用了一个脚本半夜在那跑，然后大概跑了一个小时，就不跑了。我第二天起来一看，就拷贝了四分之一的文件。幸好早晨我发现 home 目录还是可以访问的。今天对比了多次运行同一个可执行文件，使用相同的输入的输出是否一致。理论上来说，应该每一次输出的文件都是一样的。然而！并不一样。有的时候是图片上有奇怪的纹理，有的时候就连输出的图片的尺寸都不一样。我又惊呆了耶。和他们讨论了一下，表示不清楚，但应该是我们的程序的锅，当然也有可能是编译器或者 CPU，哎呀都有可能啦。现在怀疑是浮点数有误差，但不知道哪来的误差。他们说之前用 icc 的时候就有过问题，GCC 到现在好像都不太对劲。所以我这两天就要测试这个了，使用不同的 GCC 版本，搭配不同的编译参数。
</p>
<p>
下午下班之前，发生了事故！我把 home 目录下的所有文件都删没了。rm -rf 了解一下。事情是这样发生的，昨天晚上说要拷贝一些文件到我自己电脑上，然后我就把服务器的 home 目录挂在到了我电脑上。这里有第一个疏忽，既然不需要修改文件，我应该把它挂载为只读。然后下班前，我看到那些拷贝回来的文件，想了想: 嗯，这些不需要了，rm -rf。这里是最明显的疏忽，我忘了其中的一个文件夹上面挂载着服务器的 home 目录。然后刷刷刷，删了有一会儿。我还想着怎么这么慢，而且还有奇怪的网络流量。然后我看了一下网络连接，嗯没错，有个 ssh 连接。然后我当时心都凉了，赶紧远程登陆服务器，就剩一个光秃秃的 bash 命令行了，配置文件也被删掉了，得到了一个和上班第一天一样干净的 home 目录。
</p>

<h3>2019 年 5 月 23 日</h3>
<p>
好吧，我们确实遇上了 GCC 的 bug。使用 GCC 7.3 编译的程序，每一次运行结果都很不一样哎。GCC 9.1 确实是没问题了。我们用的编译参数是 <code>-O3 -march=native</code>, 这个 <code>-march=native</code> 似乎是允许 GCC 使用了一些新的指令集，并自动向量化 (auto-vectorization) 了一些代码，但是生成的代码可能有问题。然后每一次运行的结果都不一样。Intel 家的编译器 icc 也有这个问题。#程序员的玄学
</p>
